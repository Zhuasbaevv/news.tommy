<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новости Томми</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        body { font-family: 'Trebuchet MS', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding-bottom: 50px; }
        header { background: #1a1a1a; padding: 25px; text-align: center; border-bottom: 4px solid #ff4757; cursor: pointer; }
        h1 { margin: 0; letter-spacing: 3px; font-size: 28px; color: #fff; }
        .container { max-width: 650px; margin: auto; padding: 15px; }
        
        /* Скрытая админка */
        #admin-panel { background: #222; padding: 20px; border-radius: 12px; display: none; margin-bottom: 30px; border: 1px solid #333; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #333; color: #fff; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; }
        .btn-pub { background: #ff4757; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 16px; }
        
        /* Карточки новостей */
        .post { background: #1a1a1a; margin-bottom: 30px; border-radius: 12px; overflow: hidden; border: 1px solid #222; position: relative; transition: 0.3s; }
        .post:hover { border-color: #444; }
        .post img { width: 100%; max-height: 400px; object-fit: cover; display: block; }
        .post-info { padding: 20px; }
        .post-info h2 { margin: 0 0 12px 0; color: #ff4757; font-size: 22px; }
        .post-info p { line-height: 1.6; color: #ccc; margin: 0; white-space: pre-wrap; }
        .date { font-size: 11px; color: #666; margin-bottom: 8px; }
        
        /* Кнопка удаления */
        .del-btn { position: absolute; top: 10px; right: 10px; background: rgba(255, 71, 87, 0.8); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; display: none; z-index: 5; }
        .admin-mode .del-btn { display: block; }
        .hidden { display: none; }
    </style>
</head>
<body id="body">

<header onclick="activateAdmin()">
    <h1>НОВОСТИ ТОММИ</h1>
</header>

<div class="container">
    <div id="admin-panel">
        <h2 style="text-align:center; color: #fff;">Админ-панель</h2>
        <input type="text" id="post-title" placeholder="Заголовок новости">
        <textarea id="post-text" rows="5" placeholder="Текст новости..."></textarea>
        <p style="font-size: 13px; color: #888;">Добавить фото:</p>
        <input type="file" id="post-file" accept="image/*" style="background: none; border: none;">
        <button class="btn-pub" onclick="publish()">ОПУБЛИКОВАТЬ</button>
        <p id="upload-status" style="text-align: center; color: #ff4757;"></p>
    </div>

    <div id="feed">
        <p style="text-align:center;">Загрузка свежих новостей...</p>
    </div>
</div>

<script>
    // Твой конфиг уже здесь!
    const firebaseConfig = {
        apiKey: "AIzaSyD6NVFOGnCVVgzh-ijtAK_bUWmewRqm8vY",
        authDomain: "tommynews-a46bb.firebaseapp.com",
        projectId: "tommynews-a46bb",
        storageBucket: "tommynews-a46bb.firebasestorage.app",
        messagingSenderId: "263117878730",
        appId: "1:263117878730:web:9f88d07d8305d9169bcb33"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Вход в админку (5 кликов по заголовку)
    let clicks = 0;
    function activateAdmin() {
        clicks++;
        if (clicks >= 5) {
            let pass = prompt("Введите пароль Томми:");
            if (pass === "777") { // Можешь сменить пароль здесь
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('body').classList.add('admin-mode');
                alert("Доступ открыт!");
            }
            clicks = 0;
        }
    }

    // Функция публикации
    async function publish() {
        const title = document.getElementById('post-title').value;
        const text = document.getElementById('post-text').value;
        const file = document.getElementById('post-file').files[0];
        const status = document.getElementById('upload-status');

        if (!title || !text) return alert("Заполни заголовок и текст!");

        status.innerText = "Публикация... подожди";
        let photoUrl = "";

        try {
            if (file) {
                const ref = storage.ref('news/' + Date.now() + "_" + file.name);
                await ref.put(file);
                photoUrl = await ref.getDownloadURL();
            }

            await db.collection("posts").add({
                title: title,
                text: text,
                img: photoUrl,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Очистка
            document.getElementById('post-title').value = "";
            document.getElementById('post-text').value = "";
            document.getElementById('post-file').value = "";
            status.innerText = "Опубликовано!";
            setTimeout(() => status.innerText = "", 3000);

        } catch (err) {
            console.error(err);
            alert("Ошибка! Проверь, включены ли Firestore и Storage в консоли Firebase (Test Mode)");
        }
    }

    // Загрузка постов в реальном времени
    db.collection("posts").orderBy("createdAt", "desc").onSnapshot(snapshot => {
        const feed = document.getElementById('feed');
        if (snapshot.empty) {
            feed.innerHTML = "<p style='text-align:center;'>Новостей пока нет.</p>";
            return;
        }
        feed.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const dateStr = data.createdAt ? data.createdAt.toDate().toLocaleString() : "";
            feed.innerHTML += `
                <div class="post">
                    <button class="del-btn" onclick="deletePost('${doc.id}')">Удалить</button>
                    ${data.img ? `<img src="${data.img}">` : ''}
                    <div class="post-info">
                        <div class="date">${dateStr}</div>
                        <h2>${data.title}</h2>
                        <p>${data.text}</p>
                    </div>
                </div>`;
        });
    });

    // Удаление
    async function deletePost(id) {
        if (confirm("Точно удалить эту новость?")) {
            await db.collection("posts").doc(id).delete();
        }
    }
</script>
</body>
</html>
