<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новости Tommy — Админ-панель</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        header { background: #007bff; color: white; padding: 20px; text-align: center; }
        .container { max-width: 700px; margin: 20px auto; padding: 10px; }
        
        /* Стили новостей */
        .news-card { background: white; margin-bottom: 25px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; }
        .news-card img { width: 100%; max-height: 400px; object-fit: cover; }
        .news-content { padding: 20px; }
        .del-btn { display: none; background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; position: absolute; top: 10px; left: 10px; }

        /* Стили админки */
        #admin-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; display: none; border: 2px solid #007bff; }
        input, textarea { width: 100%; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        #login-section { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<header>
    <h1>Новости Tommy</h1>
    <div id="login-section">
        <button class="btn" onclick="showLogin()">Вход для админа</button>
    </div>
</header>

<div class="container">
    <div id="admin-panel">
        <h3>Добавить новость</h3>
        <input type="text" id="img-url" placeholder="Ссылка на фото (или путь images/photo.jpg)">
        <textarea id="news-text" rows="4" placeholder="Текст новости..."></textarea>
        <button class="btn" onclick="publishNews()">Опубликовать на GitHub</button>
        <button class="btn" style="background:#666" onclick="location.reload()">Выход</button>
    </div>

    <div id="news-container">
        </div>
</div>

<script>
    let GITHUB_TOKEN = "";
    const REPO = "Zhuasbaevv/news.tommy"; // Проверь имя!

    function showLogin() {
        const pass = prompt("Введите ваш GitHub Token для доступа к кнопкам:");
        if (pass) {
            GITHUB_TOKEN = pass;
            document.getElementById('admin-panel').style.display = 'block';
            document.querySelectorAll('.del-btn').forEach(b => b.style.display = 'block');
            alert("Режим админа включен!");
        }
    }

    async function publishNews() {
        const img = document.getElementById('img-url').value;
        const text = document.getElementById('news-text').value;
        if (!text) return alert("Введите текст!");

        const newPost = `
<div class="news-card">
    <button class="del-btn" onclick="this.parentElement.remove(); saveChanges();">Удалить</button>
    ${img ? `<img src="${img}">` : ''}
    <div class="news-content">
        <p>${text.replace(/\n/g, '<br>')}</p>
    </div>
</div>`;

        const container = document.getElementById('news-container');
        container.insertAdjacentHTML('afterbegin', newPost);
        await saveChanges();
    }

    async function saveChanges() {
        if (!GITHUB_TOKEN) return alert("Ошибка: Нет токена!");

        try {
            // 1. Получаем текущий файл
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/index.html`);
            const data = await res.json();
            let content = decodeURIComponent(escape(atob(data.content)));

            // 2. Обновляем блок новостей
            const containerHtml = document.getElementById('news-container').innerHTML;
            const startTag = "";
            const newContent = content.replace(
                new RegExp(`${startTag}[\\s\\S]*?</div>\\s*</div>`, 'm'), 
                `${startTag}${containerHtml}`
            );

            // 3. Отправляем обратно на GitHub
            const updateRes = await fetch(`https://api.github.com/repos/${REPO}/contents/index.html`, {
                method: "PUT",
                headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: "Обновление новостей через админку",
                    content: btoa(unescape(encodeURIComponent(newContent))),
                    sha: data.sha
                })
            });

            if (updateRes.ok) alert("Успешно сохранено на сервере!");
            else alert("Ошибка сохранения. Проверьте токен.");
        } catch (e) {
            console.error(e);
            alert("Произошла ошибка при связи с GitHub");
        }
    }
</script>

</body>
</html>
