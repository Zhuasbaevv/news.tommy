<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новости Tommy</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; color: #1c1e21; }
        header { background: #007bff; color: white; padding: 30px 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; cursor: pointer; user-select: none; }
        
        .container { max-width: 700px; margin: 20px auto; padding: 0 15px; }
        
        /* Стили карточек новостей */
        .news-card { background: white; margin-bottom: 25px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; border: 1px solid #e0e0e0; }
        .news-card img { width: 100%; max-height: 450px; object-fit: cover; display: block; background: #ddd; }
        .news-content { padding: 20px; }
        .news-content p { line-height: 1.6; margin: 0; font-size: 18px; white-space: pre-wrap; }

        /* Кнопка удаления (только для админа) */
        .del-btn { display: none; background: #ff4747; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; position: absolute; top: 15px; left: 15px; z-index: 10; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Панель админа */
        #admin-panel { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; display: none; border: 3px solid #007bff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #admin-panel h3 { margin-top: 0; color: #007bff; }
        input, textarea { width: 100%; margin-bottom: 15px; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus, textarea:focus { border-color: #007bff; }
        .btn { background: #007bff; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn:hover { background: #0056b3; }
        .btn-cancel { background: #6e7881; margin-top: 10px; }
        #status { margin-top: 10px; font-weight: bold; text-align: center; display: none; }
    </style>
</head>
<body>

<header>
    <h1 id="secret-trigger" onclick="handleSecretClick()">Новости Tommy</h1>
    <p style="font-size: 0.9em; opacity: 0.8;">Актуальные события города</p>
</header>

<div class="container">
    <div id="admin-panel">
        <h3>Новая публикация</h3>
        <input type="text" id="img-url" placeholder="Имя фото (напр. 1.jpg) или ссылка">
        <textarea id="news-text" rows="5" placeholder="Что произошло?"></textarea>
        <button class="btn" id="save-btn" onclick="publishNews()">Опубликовать на сайт</button>
        <div id="status">Сохранение... Подождите...</div>
        <button class="btn btn-cancel" onclick="closeAdmin()">Закрыть панель</button>
    </div>

    <div id="news-container">
        </div>
</div>

<script>
    let GITHUB_TOKEN = "";
    const REPO = "Zhuasbaevv/news.tommy"; 
    let clickCount = 0;

    // Секретный вход: 5 кликов по заголовку за 3 секунды
    function handleSecretClick() {
        clickCount++;
        if (clickCount === 5) {
            const pass = prompt("Введите ваш GitHub Token:");
            if (pass) {
                GITHUB_TOKEN = pass;
                document.getElementById('admin-panel').style.display = 'block';
                document.querySelectorAll('.del-btn').forEach(b => b.style.display = 'block');
                alert("Доступ разрешен!");
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
            clickCount = 0;
        }
        setTimeout(() => { clickCount = 0; }, 3000);
    }

    function closeAdmin() {
        document.getElementById('admin-panel').style.display = 'none';
        document.querySelectorAll('.del-btn').forEach(b => b.style.display = 'none');
    }

    async function publishNews() {
        const img = document.getElementById('img-url').value.trim();
        const text = document.getElementById('news-text').value.trim();
        
        if (!text) return alert("Напишите хотя бы текст новости!");

        const saveBtn = document.getElementById('save-btn');
        const status = document.getElementById('status');
        
        saveBtn.disabled = true;
        status.style.display = 'block';

        const newPostHtml = `
<div class="news-card">
    <button class="del-btn" style="display:block" onclick="deletePost(this)">Удалить</button>
    ${img ? `<img src="${img}" alt="Фото новости">` : ''}
    <div class="news-content">
        <p>${text}</p>
    </div>
</div>`;

        const container = document.getElementById('news-container');
        container.insertAdjacentHTML('afterbegin', newPostHtml);
        
        await saveToGithub();
        
        saveBtn.disabled = false;
        status.style.display = 'none';
        document.getElementById('img-url').value = "";
        document.getElementById('news-text').value = "";
    }

    async function deletePost(btn) {
        if(confirm("Удалить этот пост?")) {
            btn.parentElement.remove();
            await saveToGithub();
        }
    }

    async function saveToGithub() {
        if (!GITHUB_TOKEN) return alert("Ошибка: Токен не введен!");

        try {
            // Загружаем текущую версию файла с GitHub
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/index.html?t=${Date.now()}`);
            const data = await res.json();
            const oldCode = decodeURIComponent(escape(atob(data.content)));

            const containerHtml = document.getElementById('news-container').innerHTML;
            
            const startTag = "";
            const parts = oldCode.split(startTag);
            
            if (parts.length < 2) return alert("Ошибка структуры файла! Метка NEWS_START не найдена.");

            // Собираем новый код: всё что ДО метки + метка + новые посты + всё что после контейнера
            // Ищем конец контейнера (первый закрывающий div после NEWS_START в старом коде)
            const remainingCode = parts[1].substring(parts[1].indexOf('</div>') + 6);
            const newFullCode = parts[0] + startTag + "\n" + containerHtml + remainingCode;

            const updateRes = await fetch(`https://api.github.com/repos/${REPO}/contents/index.html`, {
                method: "PUT",
                headers: { 
                    "Authorization": `token ${GITHUB_TOKEN}`, 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify({
                    message: "Сайт обновлен через админку",
                    content: btoa(unescape(encodeURIComponent(newFullCode))),
                    sha: data.sha
                })
            });

            if (updateRes.ok) {
                alert("✅ Готово! Изменения вступят в силу через 1-2 минуты (нужно время для сборки GitHub).");
            } else {
                alert("Ошибка сохранения. Возможно, токен не имеет прав 'repo'.");
            }
        } catch (e) {
            alert("Критическая ошибка: " + e);
        }
    }
</script>

</body>
</html>
